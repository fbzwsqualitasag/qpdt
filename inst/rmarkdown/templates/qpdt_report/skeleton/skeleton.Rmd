---
title: Pedigree Check Report For `r params$pedigreeName`
date: "`r Sys.Date()`"
author: "`r params$reportAuthor`"
output: html_document
params:
  pedigreePath:
    label: "Path To Pedigree Input File"
    value: ""
  pedigreeName:
    label: "Pedigree Name"
    value: ""
  pedigreeType:
    label: "Pedigree Type"
    value: "generic"  
    choices: ["generic", "gnm", "argus"]
  reportAuthor:
    label: "Report Author"
    value: ""
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r parameter-settings, echo=FALSE}
if (params$pedigreeType == 'gnm'){
  l_settings <- qpdt::get_gnm_prp_settings()  
} else if (params$pedigreeType == 'argus'){
  l_settings <- qpdt::get_argus_prp_settings()
} else {
  l_settings <- qpdt::get_generic_settings()
}

```

# Disclaimer
This document contains the report for the pedigree: __`r params$pedigreeName`__. The report is generated by the function `qpdt::create_report()`. The report should show potential problems with the input pedigrees.


# General Properties
It is assumed that the pedigree to be checked in this report is given by a tabular representation. Each row in the table specifies for each animal the available information, such as sire, dam, date of birth and further information.  

Animals in a pedigree must be identified by unique identifiers. These identifiers are also used to assign parents to animals. The check for the uniqueness of the identifiers yields the following result.

```{r id-check, echo=FALSE, message=FALSE, warning=FALSE}
l_pedig_id_result <- qpdt::check_pedig_id(ps_pedig_path = params$pedigreePath, 
                                          ps_id_col     = l_settings$id_col,
                                          ps_delim      = l_settings$col_delim)
```

The currently checked pedigree is imported from: `r l_pedig_id_result$PedFile`. 

The results of the uniqueness check of the identifiers is shown in the table below.

```{r tbl-uni-id, echo=FALSE, message=FALSE, warning=FALSE}
n_nr_dupl <- ifelse(is.null(l_pedig_id_result$TblDuplicates), 0, nrow(l_pedig_id_result$TblDuplicates))
tbl_uni_id <- tibble::tibble(Property = c('Number of records',
                                          'Number of animals',
                                          'Number of duplicate IDs'),
                             Value    = c(l_pedig_id_result$NrRecord,
                                          l_pedig_id_result$NrAnimals,
                                          n_nr_dupl))
knitr::kable(tbl_uni_id)
```

In case the above check found some duplicate identifiers, they are shown in the table below.

```{r echo=FALSE, include=(n_nr_dupl > 0)}
 knitr::kable(l_pedig_id_result$TblDuplicates)
```


# Parents
Parents of animals must fullfill certain properties. The following properties are checked

* number of animals without parents
* number of parents which do not appear as animals
* number of parents with inconsistent birthdates
* number of parents that have the same ID as their offspring
* number of parents which have the wrong sex

The following table shows the numbers of all the checked properties.

```{r parent-check, echo=FALSE, message=FALSE, warning=FALSE}
l_parent_result <- qpdt::check_pedig_parent(ps_pedig_path = params$pedigreePath,
                                            ps_id_col        = l_settings$id_col,
                                            ps_sire_col      = l_settings$sire_col,
                                            ps_dam_col       = l_settings$dam_col,
                                            ps_bd_col        = l_settings$bd_col,
                                            ps_sex_col       = l_settings$sex_col)

nr_sire_incon_bd <- nrow(l_parent_result$TblSireBdate)
nr_dam_incon_bd <- nrow(l_parent_result$TblDamBdate)
tbl_parent_result <- tibble::tibble(Property = c('Number of animals with missing sires',
                                                 'Number of animals with missing dams',
                                                 'Number of sires not occuring as animals',
                                                 'Number of dams not occurding as animals',
                                                 'Number of sires with inconsistent birthdates',
                                                 'Number of dams with inconsistent birthdates'),
                                    Value    = c(l_parent_result$NrMissingSire,
                                                 l_parent_result$NrMissingDam,
                                                 l_parent_result$NrSireNotAnimal,
                                                 l_parent_result$NrDamNotAnimal,
                                                 nr_sire_incon_bd,
                                                 nr_dam_incon_bd))
knitr::kable(tbl_parent_result)
```

In case that there are pedigree records with inconsistent information concerning parents of animals, the respective records are shown in the table below.

```{r, echo=FALSE, results='asis', include=(nr_sire_incon_bd == 0)}
cat("\n<!--\n")
```

The records with inconsistent birthdates between animals and sires are shown in the table below.

```{r echo=FALSE}
knitr::kable(l_parent_result$TblSireBdate)
```

```{r, echo=FALSE, results='asis', include=(nr_sire_incon_bd == 0)}
cat("\n-->\n\n")
```


```{r latest-change, echo=FALSE, results='asis'}
cat("\n\n---\n", "_Latest Changes: ", format(Sys.time(), format = "%Y-%m-%d %H:%M:%S"), " (", Sys.info()[['user']], ")_")
```

